# 总得分未记录问题 - 诊断指南

我已经改进了代码并添加了详细的调试信息。请按照以下步骤诊断问题：

## 第一步：检查浏览器控制台

1. 打开您的 `index.html` 文件
2. 按 **F12** 打开开发者工具
3. 切换到 **Console（控制台）** 标签
4. 完成问卷并点击「查看评估报告」
5. 查看控制台输出，应该看到：
   ```
   ========== 准备提交数据 ==========
   完整数据: {timestamp: "...", totalScore: 24, ...}
   总得分: 24 (类型: number)
   尝试方法1: 表单 POST 提交...
   尝试方法2: JSON POST 提交...
   尝试方法3: GET 提交...
   ========== 提交完成 ==========
   ✓ 所有提交方法已尝试
     - 总得分: 24
   ```

**如果看不到这些信息**：
- 检查 `GOOGLE_SCRIPT_URL` 是否正确配置
- 检查 `ENABLE_GOOGLE_SHEETS` 是否为 `true`

## 第二步：检查 Google Apps Script 执行日志

1. 打开您的 Google Sheets
2. 点击 **扩展程序** > **Apps Script**
3. 点击左侧菜单的 **执行**（或 **Executions**）
4. 查看最近的执行记录
5. 点击任意一条记录查看详情

**应该看到的日志**：
```
========== 收到 POST 请求 ==========
postData 类型: application/x-www-form-urlencoded
parameter keys: data
方法1: 从 parameter.data 解析数据
成功解析 parameter.data
========== 开始处理数据 ==========
收到数据对象: {...}
总得分原始值: 24 (类型: number)
总得分 (数字): 24
✓ 数据行已追加到工作表
验证: 最后一行 = 3, B列值 = 24
✓ 数据已成功保存，总得分: 24
```

**如果没有执行记录**：
- 说明请求根本没有到达 Google Apps Script
- 检查 Web App URL 是否正确
- 检查部署权限是否设置为「所有人」

**如果有错误**：
- 查看错误详情
- 检查 `SPREADSHEET_ID` 是否正确
- 检查工作表名称是否正确

## 第三步：检查 Google Sheets

1. 打开您的 Google Sheets
2. 检查是否有新行添加（在表头下方）
3. 检查 **B列（第二列）** 是否有数值

**如果没有新行**：
- 查看 Apps Script 执行日志中的错误信息
- 确认表头是否正确（B列应该是「总分」）

**如果 B列是空的**：
- 查看执行日志中「准备写入的数据行」的值
- 检查 row[1] 的值是否正确

## 第四步：手动测试 Google Apps Script

在 Google Apps Script 编辑器中：

1. 选择 `test()` 函数
2. 点击运行按钮（▶️）
3. 授权访问（如果需要）
4. 查看执行日志
5. 检查 Google Sheets 是否有测试数据

如果测试函数成功，说明脚本代码没问题，问题可能在数据传输。

## 第五步：检查配置

### 1. HTML 配置检查
在 `index.html` 中：
```javascript
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/.../exec';
const ENABLE_GOOGLE_SHEETS = true;
```

### 2. Google Apps Script 配置检查
在 `google-apps-script.js` 中：
```javascript
const SPREADSHEET_ID = '您的GoogleSheetsID';
const SHEET_NAME = 'Sheet1';  // 或您的实际表名称
```

### 3. 获取 Google Sheets ID
在 Google Sheets 的 URL 中：
```
https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit
                                ↑ 这就是 ID
```

### 4. 表头检查
确保第一行表头为：
```
A1: 时间戳
B1: 总分      ← 第二列
C1: 等级
D1: 等级文本
...
```

## 常见问题排查

### 问题 1: 控制台显示"所有提交方法已尝试"，但 Sheets 没有数据

**可能原因**：
- Google Apps Script 没有收到请求
- 部署权限设置不正确

**解决方案**：
1. 检查 Web App 的访问权限是否设置为「所有人」
2. 创建新的部署版本
3. 在浏览器中直接访问 Web App URL，应该看到错误信息（这是正常的）

### 问题 2: Apps Script 日志显示"无法解析数据"

**可能原因**：
- 数据格式不匹配

**解决方案**：
1. 查看日志中的 "received" 部分，看实际收到了什么
2. 可能需要调整数据解析逻辑

### 问题 3: 数据保存了，但总得分是 0

**可能原因**：
- `data.totalScore` 的值不正确
- 类型转换问题

**解决方案**：
1. 查看日志中的 "总得分原始值" 和 "总得分 (数字)"
2. 检查 HTML 中是否正确计算了 `totalScore`

### 问题 4: 出现 CORS 错误

**说明**：
- 使用 `no-cors` 模式时看不到响应是正常的
- 代码已经使用了 `no-cors`，不应该出现 CORS 错误
- 如果出现，可能是浏览器或网络问题

## 快速测试方法

1. 在浏览器控制台手动执行：
```javascript
fetch('YOUR_GOOGLE_SCRIPT_URL?data=' + encodeURIComponent('{"totalScore":99,"timestamp":"test"}'), {
  method: 'GET',
  mode: 'no-cors'
});
```

2. 检查 Google Sheets 是否有新行，B列是否为 99

## 需要更多帮助？

请提供以下信息：
1. 浏览器控制台的完整输出（截图或复制文字）
2. Google Apps Script 执行日志的内容（截图或复制文字）
3. Google Sheets 的当前状态（是否有新行，B列的值是什么）
4. `SPREADSHEET_ID` 是否正确（可以隐藏真实 ID，只告诉我长度）

这些信息可以帮助我准确定位问题。
